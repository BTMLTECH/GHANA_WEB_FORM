<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BTM Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: #f4f6f8;
    }

    header {
      background: #203a43;
      color: #fff;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header button {
      background: #fff;
      color: #203a43;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    main {
      padding: 24px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }

    .top-bar input {
      padding: 10px;
      width: 280px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,.05);
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      text-align: left;
    }

    th {
      background: #f0f2f5;
      font-weight: 600;
    }

    tr:hover {
      background: #f9fafb;
    }

    .delete-btn {
      background: #dc2626;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .empty {
      padding: 20px;
      text-align: center;
      color: #6b7280;
    }
  </style>
</head>

<body>

<header>
  <h3>BTM Client Dashboard</h3>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <h2 id="welcome"></h2>

  <div class="top-bar">
    <input id="searchInput" placeholder="Search customers..." />
  </div>

  <table>
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Agency</th>
        <th>Registered</th>
        <th>IATA</th>
        <th>Platform</th>
        <th>Date</th>
        <th id="actionHeader">Action</th>
      </tr>
    </thead>
    <tbody id="clients"></tbody>
  </table>

  <div id="emptyState" class="empty" style="display:none;">
    No customers found.
  </div>
</main>

<script>
const DB = "https://btm-webform-default-rtdb.firebaseio.com";

// ðŸ” AUTH GUARD
const user = JSON.parse(localStorage.getItem("btmUser"));
if (!user) window.location.href = "login.html";

document.getElementById("welcome").textContent =
  `Welcome ${user.name} (${user.role})`;

if (user.role !== "admin") {
  document.getElementById("actionHeader").style.display = "none";
}

// ðŸšª LOGOUT
function logout() {
  localStorage.removeItem("btmUser");
  window.location.href = "login.html";
}

let customers = [];

// ðŸ“¥ LOAD CUSTOMERS (LATEST FIRST)
async function loadCustomers() {
  const res = await fetch(`${DB}/subcription.json`);
  const data = await res.json();

  if (!data) return;

  customers = Object.entries(data)
    .map(([id, value]) => ({ id, ...value }))
    .reverse(); // newest first

  renderTable(customers);
}

function renderTable(list) {
  const tbody = document.getElementById("clients");
  tbody.innerHTML = "";

  if (!list.length) {
    document.getElementById("emptyState").style.display = "block";
    return;
  }

  document.getElementById("emptyState").style.display = "none";

  list.forEach(c => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${c.Full_name || ""}</td>
      <td>${c.Email || ""}</td>
      <td>${c.Phone_Number || ""}</td>
      <td>${c.Agency_name || ""}</td>
      <td>${c.registerd || ""}</td>
      <td>${c.IATA || ""}</td>
      <td>${c.Platform_Type || ""}</td>
      <td>${c.Date || ""}</td>
      ${
        user.role === "admin"
          ? `<td><button class="delete-btn" onclick="deleteCustomer('${c.id}')">Delete</button></td>`
          : `<td></td>`
      }
    `;
    tbody.appendChild(row);
  });
}

// ðŸ” SEARCH
document.getElementById("searchInput").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  const filtered = customers.filter(c =>
    Object.values(c).some(v =>
      String(v).toLowerCase().includes(q)
    )
  );
  renderTable(filtered);
});

// ðŸ—‘ DELETE (ADMIN ONLY)
async function deleteCustomer(id) {
  if (!confirm("Are you sure you want to delete this customer?")) return;

  await fetch(`${DB}/subcription/${id}.json`, { method: "DELETE" });
  customers = customers.filter(c => c.id !== id);
  renderTable(customers);
}

loadCustomers();
</script>

</body>
</html>
